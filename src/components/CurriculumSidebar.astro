---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";

interface Props {
  currentPath: string;
}

const { currentPath } = Astro.props;
const allEntries = await getCollection("curriculum");

// Separate main modules and subpages
const mainModules = allEntries.filter((entry) => !entry.data.parentModule);
const subpages = allEntries.filter((entry) => entry.data.parentModule);

// Sort main modules by order
const sortedMainModules = mainModules.sort(
  (a, b) => a.data.order - b.data.order
);

// Group subpages by parent module
const subpagesByModule = new Map<string, CollectionEntry<"curriculum">[]>();
subpages.forEach((subpage) => {
  const parentModule = subpage.data.parentModule;
  if (parentModule) {
    if (!subpagesByModule.has(parentModule)) {
      subpagesByModule.set(parentModule, []);
    }
    subpagesByModule.get(parentModule)?.push(subpage);
  }
});

// Sort subpages within each module
subpagesByModule.forEach((pages) => {
  pages.sort((a, b) => a.data.order - b.data.order);
});
---

<nav class="w-64 bg-gray-50 dark:bg-gray-800 rounded-xl p-6 m-4 mr-0">
  <div class="space-y-6">
    {
      sortedMainModules.map((module) => {
        const moduleSubpages = subpagesByModule.get(module.data.title) || [];
        const isCurrentModule =
          currentPath === `/curriculum/${module.slug}` ||
          moduleSubpages.some(
            (subpage) => currentPath === `/curriculum/${subpage.slug}`
          );

        return (
          <div class="space-y-3">
            <div class="flex items-center gap-3">
              <span class="text-xl font-bold text-yellow-400">
                {String(module.data.order).padStart(2, "0")}
              </span>
              <a
                href={`/curriculum/${module.slug}`}
                class:list={[
                  "block font-medium transition-colors",
                  "hover:text-yellow-600 dark:hover:text-yellow-400",
                  isCurrentModule
                    ? "text-yellow-600 dark:text-yellow-400"
                    : "text-gray-800 dark:text-gray-200",
                ]}
              >
                {module.data.title}
              </a>
            </div>

            {moduleSubpages.length > 0 && (
              <div class="pl-8 space-y-2 border-l-2 border-gray-200 dark:border-gray-700">
                {moduleSubpages.map((subpage) => (
                  <a
                    href={`/curriculum/${subpage.slug}`}
                    class:list={[
                      "block text-sm transition-colors",
                      "hover:text-yellow-600 dark:hover:text-yellow-400",
                      currentPath === `/curriculum/${subpage.slug}`
                        ? "text-yellow-600 dark:text-yellow-400"
                        : "text-gray-600 dark:text-gray-400",
                    ]}
                  >
                    {subpage.data.title}
                  </a>
                ))}
              </div>
            )}
          </div>
        );
      })
    }
  </div>
</nav>
