---
import CurriculumLayout from "../../layouts/CurriculumLayout.astro";
import { getEntry, getCollection } from "astro:content";

const { slug } = Astro.params;
const slugParts = (slug as string).split("/");

// Get the main curriculum entry
const curriculumEntry = await getEntry("curriculum", slugParts[0]);

if (!curriculumEntry) {
  return Astro.redirect("/404");
}

// Get the rendered content
let Content;
let frontmatter = curriculumEntry.data;

// If we have a subpage, get its content
if (slugParts.length > 1) {
  const subpageId = slugParts[1];
  const subpagePath = `src/content/curriculum/${slugParts[0]}/${subpageId}/index.md`;

  try {
    const subpageEntry = await getEntry(
      "curriculum",
      `${slugParts[0]}/${subpageId}`
    );
    if (subpageEntry) {
      const rendered = await subpageEntry.render();
      Content = rendered.Content;
      frontmatter = subpageEntry.data;
    } else {
      return Astro.redirect("/404");
    }
  } catch (error) {
    return Astro.redirect("/404");
  }
} else {
  const rendered = await curriculumEntry.render();
  Content = rendered.Content;
}

// Get all curriculum entries for navigation
const allCurriculum = await getCollection("curriculum");
---

<CurriculumLayout frontmatter={frontmatter} allCurriculum={allCurriculum}>
  <Content />
</CurriculumLayout>
